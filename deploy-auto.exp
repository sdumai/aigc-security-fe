#!/usr/bin/expect -f

# AIGC å®‰å…¨å¹³å° - è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼ˆä½¿ç”¨ expectï¼‰
# ä½¿ç”¨æ–¹æ³•: chmod +x deploy-auto.exp && ./deploy-auto.exp

set timeout 300
set remote_host "10.102.32.144"
set remote_user "lab426"
set remote_pass "426"
set remote_dir "aigc-security-platform"
set remote_port "5670"

puts "\nğŸš€ AIGC å®‰å…¨å¹³å° - è‡ªåŠ¨åŒ–éƒ¨ç½²"
puts "================================\n"

# æ­¥éª¤ 1: åˆ›å»ºè¿œç¨‹ç›®å½•
puts "ğŸ“ æ­¥éª¤ 1/4: åˆ›å»ºè¿œç¨‹ç›®å½•..."
spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${remote_user}@${remote_host} "mkdir -p ~/${remote_dir}"
expect {
    "password:" {
        send "${remote_pass}\r"
        expect {
            eof {
                puts "âœ… è¿œç¨‹ç›®å½•åˆ›å»ºæˆåŠŸ\n"
            }
            timeout {
                puts "âŒ åˆ›å»ºç›®å½•è¶…æ—¶"
                exit 1
            }
        }
    }
    "Permission denied" {
        puts "âŒ æƒé™è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥å¯†ç "
        exit 1
    }
    timeout {
        puts "âŒ è¿æ¥è¶…æ—¶"
        exit 1
    }
}

# æ­¥éª¤ 2: æ‰“åŒ…æœ¬åœ°æ–‡ä»¶
puts "ğŸ“¦ æ­¥éª¤ 2/4: æ‰“åŒ…æœ¬åœ°æ–‡ä»¶..."
set pack_result [exec bash -c "cd dist && tar czf ../dist.tar.gz . 2>&1"]
puts "âœ… æ–‡ä»¶æ‰“åŒ…å®Œæˆ\n"

# æ­¥éª¤ 3: ä¸Šä¼ å‹ç¼©åŒ…
puts "ğŸ“¤ æ­¥éª¤ 3/4: ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼ˆè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰..."
spawn scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null dist.tar.gz ${remote_user}@${remote_host}:~/
expect {
    "password:" {
        send "${remote_pass}\r"
        expect {
            "100%" {
                puts "âœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆ\n"
                expect eof
            }
            timeout {
                puts "âŒ ä¸Šä¼ è¶…æ—¶"
                exit 1
            }
        }
    }
    timeout {
        puts "âŒ è¿æ¥è¶…æ—¶"
        exit 1
    }
}

# æ­¥éª¤ 4: è§£å‹å¹¶å¯åŠ¨æœåŠ¡
puts "ğŸš€ æ­¥éª¤ 4/4: è§£å‹æ–‡ä»¶å¹¶å¯åŠ¨æœåŠ¡..."
spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${remote_user}@${remote_host}
expect {
    "password:" {
        send "${remote_pass}\r"
    }
    timeout {
        puts "âŒ è¿æ¥è¶…æ—¶"
        exit 1
    }
}

# ç­‰å¾…ç™»å½•æˆåŠŸ
expect {
    -re "\[#$\] $" {
        # æˆåŠŸç™»å½•
    }
    timeout {
        puts "âŒ ç™»å½•è¶…æ—¶"
        exit 1
    }
}

# è§£å‹æ–‡ä»¶
send "cd ~/${remote_dir}\r"
expect -re "\[#$\] $"

send "tar xzf ~/dist.tar.gz\r"
expect -re "\[#$\] $"

send "rm ~/dist.tar.gz\r"
expect -re "\[#$\] $"

puts "âœ… æ–‡ä»¶è§£å‹å®Œæˆ"

# æ£€æŸ¥ http-server
send "which http-server\r"
expect {
    "http-server" {
        puts "âœ… http-server å·²å®‰è£…"
        expect -re "\[#$\] $"
    }
    -re "\[#$\] $" {
        puts "âš™ï¸  æ­£åœ¨å®‰è£… http-server..."
        send "npm install -g http-server\r"
        expect {
            -re "\[#$\] $" {
                puts "âœ… http-server å®‰è£…å®Œæˆ"
            }
            timeout {
                puts "âš ï¸  http-server å®‰è£…è¶…æ—¶ï¼Œä½†ç»§ç»­..."
            }
        }
    }
}

# åœæ­¢æ—§æœåŠ¡
send "tmux kill-session -t aigc-security 2>/dev/null || true\r"
expect -re "\[#$\] $"
puts "âœ… å·²åœæ­¢æ—§æœåŠ¡"

# å¯åŠ¨æ–°æœåŠ¡
send "tmux new-session -d -s aigc-security 'http-server . -p ${remote_port} -a 0.0.0.0'\r"
expect -re "\[#$\] $"
puts "âœ… æ–°æœåŠ¡å·²å¯åŠ¨"

# ç­‰å¾…ä¸€ä¸‹æœåŠ¡å¯åŠ¨
send "sleep 2\r"
expect -re "\[#$\] $"

# éªŒè¯æœåŠ¡çŠ¶æ€
send "tmux ls | grep aigc-security\r"
expect {
    "aigc-security" {
        puts "âœ… æœåŠ¡è¿è¡Œæ­£å¸¸"
        expect -re "\[#$\] $"
    }
    -re "\[#$\] $" {
        puts "âš ï¸  æ— æ³•ç¡®è®¤æœåŠ¡çŠ¶æ€"
    }
}

# é€€å‡º SSH
send "exit\r"
expect eof

# æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶
exec rm -f dist.tar.gz

puts "\n================================"
puts "âœ… éƒ¨ç½²æˆåŠŸï¼\n"
puts "ğŸŒ è®¿é—®åœ°å€: http://${remote_host}:${remote_port}\n"
puts "ğŸ“‹ ç®¡ç†å‘½ä»¤ï¼š"
puts "   æŸ¥çœ‹æœåŠ¡: ssh ${remote_user}@${remote_host} 'tmux attach -t aigc-security'"
puts "   åœæ­¢æœåŠ¡: ssh ${remote_user}@${remote_host} 'tmux kill-session -t aigc-security'"
puts "\n================================\n"

exit 0


