#!/usr/bin/expect -f

set timeout 300
set remote_host "10.102.32.144"
set remote_user "lab426"
set remote_pass "426"
set remote_dir "aigc-security-platform"

puts "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨..."

# 1. åˆ›å»ºè¿œç¨‹ç›®å½•
puts "ğŸ“ åˆ›å»ºè¿œç¨‹ç›®å½•..."
spawn ssh -o StrictHostKeyChecking=no ${remote_user}@${remote_host} "mkdir -p ~/${remote_dir}"
expect {
    "password:" {
        send "${remote_pass}\r"
        exp_continue
    }
    eof
}

# 2. ä¸Šä¼ distæ–‡ä»¶å¤¹
puts "ğŸ“¦ ä¸Šä¼ æ„å»ºæ–‡ä»¶..."
spawn bash -c "cd dist && tar czf - . | ssh -o StrictHostKeyChecking=no ${remote_user}@${remote_host} 'cd ~/${remote_dir} && tar xzf -'"
expect {
    "password:" {
        send "${remote_pass}\r"
        exp_continue
    }
    eof
}

# 3. åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šå¯åŠ¨æœåŠ¡
puts "ğŸ”§ é…ç½®å¹¶å¯åŠ¨æœåŠ¡..."
spawn ssh -o StrictHostKeyChecking=no ${remote_user}@${remote_host}
expect {
    "password:" {
        send "${remote_pass}\r"
    }
}

expect "$ " {
    send "cd ~/${remote_dir}\r"
}

expect "$ " {
    send "which http-server\r"
}

expect {
    "http-server" {
        puts "http-server å·²å®‰è£…"
    }
    "$ " {
        puts "å®‰è£… http-server..."
        send "npm install -g http-server\r"
        expect "$ "
    }
}

expect "$ " {
    send "tmux kill-session -t aigc-security 2>/dev/null || true\r"
}

expect "$ " {
    send "tmux new-session -d -s aigc-security 'http-server . -p 5670 -a 0.0.0.0'\r"
}

expect "$ " {
    send "echo 'âœ… æœåŠ¡å·²å¯åŠ¨åœ¨ tmux ä¼šè¯ aigc-security ä¸­'\r"
}

expect "$ " {
    send "exit\r"
}

expect eof

puts "\nâœ… éƒ¨ç½²å®Œæˆï¼"
puts "ğŸŒ è®¿é—®åœ°å€: http://10.102.32.144:5670"
puts "ğŸ“‹ æŸ¥çœ‹æœåŠ¡: ssh lab426@10.102.32.144 'tmux attach -t aigc-security'"




